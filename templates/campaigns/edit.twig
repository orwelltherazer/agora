{% extends 'layouts/admin.twig' %}

{% block title %}Modifier {{ campaign.titre }}{% endblock %}
{% block page_title %}Modifier la campagne{% endblock %}

{% block content %}
<form method="POST" action="{{ url('campaigns/update/' ~ campaign.id) }}" enctype="multipart/form-data">
    <div class="grid grid-cols-3 gap-6">
        <!-- Colonne gauche : Visuels -->
        <div class="col-span-1">
            <div class="bg-white rounded-lg shadow-sm p-4 sticky top-4">
                <h3 class="font-semibold text-gray-900 mb-3 text-sm">Visuels</h3>

                {% if files %}
                <div class="space-y-2 mb-3">
                    {% set imageIndex = 0 %}
                    {% for file in files %}
                    <div class="relative border rounded-lg p-2 group">
                        {% if file.type_mime starts with 'image/' %}
                        <img src="{{ asset(file.chemin) }}" alt="{{ file.nom_original }}"
                             onclick="openLightbox('{{ asset(file.chemin) }}', {{ imageIndex }})"
                             class="w-full h-24 object-cover rounded cursor-pointer hover:opacity-75 transition">
                        {% set imageIndex = imageIndex + 1 %}
                        {% else %}
                        <div class="w-full h-24 bg-gray-100 rounded flex items-center justify-center">
                            <i class="fas fa-file-pdf text-2xl text-gray-400"></i>
                        </div>
                        {% endif %}
                        <p class="text-xs text-gray-600 mt-1 truncate">{{ file.nom_original }}</p>
                        <a href="{{ url('campaigns/delete-file/' ~ file.id) }}"
                           onclick="return confirm('Supprimer ?')"
                           class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">
                            <i class="fas fa-times"></i>
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <input type="file" name="visuels[]" id="fileInputEdit" multiple accept="image/*,.pdf" class="hidden">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-indigo-500 transition cursor-pointer"
                     onclick="document.getElementById('fileInputEdit').click()">
                    <i class="fas fa-plus-circle text-2xl text-gray-400 mb-1"></i>
                    <p class="text-xs text-gray-600">Ajouter</p>
                </div>
                <div id="filePreviewEdit" class="grid grid-cols-1 gap-2 mt-3 hidden"></div>
            </div>
        </div>

        <!-- Colonne droite : Formulaire -->
        <div class="col-span-2 space-y-4">
            <!-- Infos principales -->
            <div class="bg-white rounded-lg shadow-sm p-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Titre *</label>
                        <input type="text" name="titre" value="{{ campaign.titre }}" required
                               class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Demandeur *</label>
                        <input type="text" name="demandeur" value="{{ campaign.demandeur }}" required
                               class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" name="demandeur_email" value="{{ campaign.demandeur_email }}"
                               class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Description</label>
                        <textarea name="description" rows="2"
                                  class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-indigo-500">{{ campaign.description }}</textarea>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Statut</label>
                        <select name="statut" class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="brouillon" {{ campaign.statut == 'brouillon' ? 'selected' : '' }}>Brouillon</option>
                            <option value="en_validation" {{ campaign.statut == 'en_validation' ? 'selected' : '' }}>En validation</option>
                            <option value="validee" {{ campaign.statut == 'validee' ? 'selected' : '' }}>Validée</option>
                            <option value="publiee" {{ campaign.statut == 'publiee' ? 'selected' : '' }}>Publiée</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Dates -->
            <div class="bg-white rounded-lg shadow-sm p-4">
                <h3 class="font-semibold text-gray-900 mb-3 text-sm">Dates</h3>
                <div class="grid grid-cols-4 gap-3">
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Début événement *</label>
                        <input type="date" name="date_event_debut" value="{{ campaign.date_event_debut }}" required
                               class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Fin événement</label>
                        <input type="date" name="date_event_fin" value="{{ campaign.date_event_fin }}"
                               class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Début parution</label>
                        <input type="date" name="date_campagne_debut" value="{{ campaign.date_campagne_debut }}"
                               class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Fin parution</label>
                        <input type="date" name="date_campagne_fin" value="{{ campaign.date_campagne_fin }}"
                               class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
            </div>

            <!-- Supports et Validateurs -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <h3 class="font-semibold text-gray-900 mb-3 text-sm">Supports</h3>
                    <div class="space-y-1">
                        {% for support in supports %}
                        <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                            <input type="checkbox" name="supports[]" value="{{ support.id }}"
                                   {{ support.id in campaign_support_ids ? 'checked' : '' }}
                                   class="w-4 h-4 text-indigo-600 rounded">
                            <span class="text-sm">{{ support.nom }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-4">
                    <h3 class="font-semibold text-gray-900 mb-3 text-sm">Validateurs</h3>
                    <div class="space-y-1">
                        {% for user in users %}
                        <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                            <input type="checkbox" name="validateurs[]" value="{{ user.id }}"
                                   {{ user.id in campaign_validator_ids ? 'checked' : '' }}
                                   class="w-4 h-4 text-indigo-600 rounded">
                            <span class="text-sm">{{ user.prenom }} {{ user.nom }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-end gap-3">
                <a href="{{ url('campaigns/show/' ~ campaign.id) }}" class="px-4 py-2 text-sm border rounded-lg hover:bg-gray-50">
                    Annuler
                </a>
                <button type="submit" class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                    Enregistrer
                </button>
            </div>
        </div>
    </div>
</form>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" onclick="closeLightbox(event)">
    <span class="lightbox-close" onclick="closeLightbox(event)">&times;</span>
    <span class="lightbox-nav lightbox-prev" onclick="navigateLightbox(-1, event)" id="lightbox-prev">&#10094;</span>
    <img id="lightbox-img" src="" alt="">
    <span class="lightbox-nav lightbox-next" onclick="navigateLightbox(1, event)" id="lightbox-next">&#10095;</span>
    <div class="lightbox-counter" id="lightbox-counter"></div>
</div>

<script>
var currentImageIndex = 0;

// Charger toutes les images dans le tableau lightbox
window.lightboxImages = [
    {% if files %}
    {% set images = [] %}
    {% for file in files %}
    {% if file.type_mime starts with 'image/' %}
    {% set images = images|merge([asset(file.chemin)]) %}
    {% endif %}
    {% endfor %}
    {% for image in images %}
    '{{ image }}'{{ not loop.last ? ',' : '' }}
    {% endfor %}
    {% endif %}
];

function updateCounter() {
    const counter = document.getElementById('lightbox-counter');
    if (window.lightboxImages.length > 1) {
        counter.textContent = (currentImageIndex + 1) + ' / ' + window.lightboxImages.length;
        counter.style.display = 'block';
    } else {
        counter.style.display = 'none';
    }

    const prev = document.getElementById('lightbox-prev');
    const next = document.getElementById('lightbox-next');
    if (window.lightboxImages.length <= 1) {
        prev.style.display = 'none';
        next.style.display = 'none';
    } else {
        prev.style.display = 'block';
        next.style.display = 'block';
    }
}

function openLightbox(imageSrc, index = 0) {
    const lightbox = document.getElementById('lightbox');
    const img = document.getElementById('lightbox-img');
    currentImageIndex = index;
    img.src = imageSrc;
    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';
    updateCounter();
}

function closeLightbox(event) {
    if (event.target.id === 'lightbox' || event.target.classList.contains('lightbox-close')) {
        const lightbox = document.getElementById('lightbox');
        lightbox.classList.remove('active');
        document.body.style.overflow = 'auto';
    }
}

function navigateLightbox(direction, event) {
    event.stopPropagation();
    if (window.lightboxImages.length <= 1) return;

    currentImageIndex += direction;
    if (currentImageIndex < 0) currentImageIndex = window.lightboxImages.length - 1;
    if (currentImageIndex >= window.lightboxImages.length) currentImageIndex = 0;

    document.getElementById('lightbox-img').src = window.lightboxImages[currentImageIndex];
    updateCounter();
}

document.addEventListener('keydown', function(e) {
    const lightbox = document.getElementById('lightbox');
    if (!lightbox.classList.contains('active')) return;

    if (e.key === 'Escape') {
        lightbox.classList.remove('active');
        document.body.style.overflow = 'auto';
    }
    if (e.key === 'ArrowLeft') {
        navigateLightbox(-1, { stopPropagation: function(){} });
    }
    if (e.key === 'ArrowRight') {
        navigateLightbox(1, { stopPropagation: function(){} });
    }
});

document.getElementById('fileInputEdit').addEventListener('change', function(e) {
    const preview = document.getElementById('filePreviewEdit');
    const files = e.target.files;

    if (files.length > 0) {
        preview.innerHTML = '';
        preview.classList.remove('hidden');

        Array.from(files).forEach((file) => {
            const reader = new FileReader();
            const fileDiv = document.createElement('div');
            fileDiv.className = 'relative border rounded-lg p-2';

            if (file.type.startsWith('image/')) {
                reader.onload = function(e) {
                    fileDiv.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-24 object-cover rounded">
                        <p class="text-xs text-gray-600 mt-1 truncate">${file.name}</p>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                fileDiv.innerHTML = `
                    <div class="w-full h-24 bg-gray-100 rounded flex items-center justify-center">
                        <i class="fas fa-file-pdf text-2xl text-gray-400"></i>
                    </div>
                    <p class="text-xs text-gray-600 mt-1 truncate">${file.name}</p>
                `;
            }

            preview.appendChild(fileDiv);
        });
    }
});
</script>
{% endblock %}
